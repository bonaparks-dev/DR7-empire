<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DR7 Empire - Authenticating...</title>
  <link rel="icon" href="/DR7logo.png" type="image/png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Exo 2', sans-serif; }
    .spinner {
      border-color: rgba(255, 255, 255, 0.2);
      border-top-color: white;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-black text-gray-200 flex items-center justify-center min-h-screen">
  <div id="loading-state" class="text-center">
    <div class="spinner w-12 h-12 rounded-full border-4 mx-auto mb-4"></div>
    <h1 class="text-2xl font-bold text-white">Finalizing Sign In</h1>
    <p class="text-gray-400 mt-2">Please wait while we securely connect your account...</p>
  </div>

  <div id="error-state" class="text-center hidden">
     <div class="w-12 h-12 rounded-full border-4 border-red-500/50 bg-red-500/20 flex items-center justify-center mx-auto mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
     </div>
    <h1 class="text-2xl font-bold text-red-400">Authentication Failed</h1>
    <p class="text-gray-400 mt-2" id="error-message">An unknown error occurred. Please try again.</p>
    <a href="/#/signin" class="mt-6 inline-block bg-white text-black px-6 py-2 rounded-full font-semibold text-sm hover:bg-gray-200">
      Return to Sign In
    </a>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const SUPABASE_URL = 'https://ahpmzjgkfxrrgxyirasa.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFocG16amdreHJyZ3h5aXJhc2EiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTcyNzc4ODM4MywiZXhwIjoyMDQzMzY0MzgzfQ.hQhVhgSA6ZxR1rKMQGWo2EQxON1wHBl9r7q7YyZvTr8';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const showError = (message) => {
      document.getElementById('loading-state').classList.add('hidden');
      document.getElementById('error-state').classList.remove('hidden');
      document.getElementById('error-message').textContent = message || 'An unexpected error occurred. Please try again.';
    };

    // Set a timeout to handle cases where the auth state change never fires
    const authTimeout = setTimeout(() => {
        showError('Authentication timed out. Please try signing in again.');
    }, 15000); // 15 seconds

    // Supabase JS client v2 automatically handles the PKCE code exchange
    // when it's initialized on a page containing the `code` in the URL.
    // We listen for the SIGNED_IN event to confirm success.
    supabase.auth.onAuthStateChange((event, session) => {
      clearTimeout(authTimeout); // Stop the timeout if we get a response

      if (event === 'SIGNED_IN' && session) {
        // Successfully signed in. The session is now stored in localStorage.
        // Redirect to the main application's root. The HashRouter will then
        // take over and the AuthContext will find the user session.
        window.location.href = '/'; 
      } else if (event === 'SIGNED_IN' && !session) {
        // This can happen if there's a token but it's invalid
        showError('The authentication token was invalid. Please try again.');
      }
      // We don't need to handle other events here. If SIGNED_IN doesn't happen, the timeout will catch it.
    });
  </script>
</body>
</html>